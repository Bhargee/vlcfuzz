<!DOCTYPE html>

<html>
<head>
  <title>vlcfuzz.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>vlcfuzz.py</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h4 id="an-rtsp-protocol-fuzzer-for-the-vlc-media-player">An RTSP protocol fuzzer for the VLC media player</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> string

<span class="hljs-keyword">from</span> optparse <span class="hljs-keyword">import</span> OptionParser</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>RTSP linebreak format, mandated by RTSP RFC whitepaper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>CRLF = <span class="hljs-string">'\r\n'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The different RTSP methods, similar to HTTP methods. Must appear at the
beginning of requests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>methods = [<span class="hljs-string">'OPTIONS'</span>, <span class="hljs-string">'DESCRIBE'</span>, <span class="hljs-string">'SETUP'</span>, <span class="hljs-string">'PLAY'</span>, <span class="hljs-string">'GET_PARAMETER'</span>,
    <span class="hljs-string">'TEARDOWN'</span>, <span class="hljs-string">'PAUSE'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Settings, changeable as user sees fit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>log_file = <span class="hljs-string">'vlcfuzz.log'</span>
user_agent_str = <span class="hljs-string">'User-Agent: VLC media player (LIVE555 Streaming Media v2010.02.10)'</span>
protocol_str = <span class="hljs-string">'AVP;unicast;client_port=36142-36143'</span>
session_str = <span class="hljs-string">'98q2y3bkkjhgier2'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The scale factor determines number of mutations (defined below) per request.
10% of a request string will be mutated. Increase this to increase mutations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mutate_scale_factor = <span class="hljs-number">.1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>File with basic EBNF grammar for an RTSP request. Requires Blab tool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>grammar_file = <span class="hljs-string">'rtsp_grammar.blab'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Deletes contents of log file on every run, so the log file is fresh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_log</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">with</span> open(log_file, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
        f.write(<span class="hljs-string">''</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Generates a random string of the lenght SIZE, for use in do_random_fuzz</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_data</span><span class="hljs-params">(size)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>String contains only uppercase letters and numbers, change if other
behavior is desired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    chars = string.ascii_uppercase + string.digits
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(random.choice(chars) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(size))</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Sends DATA (a list of request strings) to specified IP and PORT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send</span><span class="hljs-params">(data, ip, port)</span>:</span>
    <span class="hljs-keyword">try</span>:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip, port))
    <span class="hljs-keyword">except</span> socket.error, (value, msg):
        <span class="hljs-keyword">if</span> s:
            s.close()
        logger.error(<span class="hljs-string">'Could not connect to target\n %s'</span> % msg, exc_info=<span class="hljs-keyword">True</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>If connection is not possible, quit gracefully</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sys.exit(<span class="hljs-number">1</span>)

    <span class="hljs-keyword">for</span> packet <span class="hljs-keyword">in</span> data:
        logger.info(<span class="hljs-string">'Sending %s'</span> % packet)
        r = <span class="hljs-keyword">None</span>
        <span class="hljs-keyword">try</span>:
            s.send(packet)
            r = s.recv(<span class="hljs-number">1024</span>)
        <span class="hljs-keyword">except</span>:
            logger.error(<span class="hljs-string">'Could not send packet:\n%s'</span> % packet)
        logger.info(<span class="hljs-string">'Recieved %s'</span> % r)
    s.close()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>First fuzzer function, simply creates bad requests that look like:</p>
<blockquote>
<p>PAUSEJHGJSHFJGUY873687YQTWTDSHG376T38
PLAY8784YR8REYFUFHUYRIBDSH CHGBYEUYYTBB</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">junk_fuzz</span><span class="hljs-params">(min, max, step)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The length of the requests starts at MIN and increases to MAX by increments of
size STEP</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    size = min
    requests = []
    <span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> methods:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(max/step):</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>We craft the request with a method, a random string, and a
linebreak</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            req = <span class="hljs-string">'%s%s%s'</span> % (method, gen_data(size), CRLF)
            requests.append(req)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Increase request size for next request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            size += step
    <span class="hljs-keyword">return</span> requests</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Takes an incomplete request from <code>do_randomized_fuzz</code>, fills out the missing
pieces (the method and the random string data of length SIZE), and creates a
request for every method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">structured_fuzz</span><span class="hljs-params">(min, max, step, target, path, data)</span>:</span>
    size = min
    requests = []
    <span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> methods:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(max/step):
            req = <span class="hljs-string">'%s rtsp://%s/%s%s%s%s%s%s%s%s'</span> % flesh_out_data(data,method,
                                                                    size)
            requests.append(req)
            size += step
    <span class="hljs-keyword">return</span> requests</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Fuzzes with random strings as data (permissable under the RTSP RFC)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_randomized_fuzz</span><span class="hljs-params">(options, mutator_func)</span>:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>structured_formats</code> contains data sequences that are RTSP request corner
cases. The first <code>None</code> is filled in with a method, and the second with a
random string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    structured_formats = [</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Normal, though minimal, format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-keyword">None</span>, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 1'</span>,
        CRLF, user_agent_str, CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Another normal and minimal format with the order of data and user agent
string switched</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 1'</span>, CRLF,
        user_agent_str, <span class="hljs-keyword">None</span>, CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Same as above, but without a sequence number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: '</span>, <span class="hljs-keyword">None</span>,
        CRLF, user_agent_str, CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Added Accept string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 2'</span>, CRLF,
        <span class="hljs-string">'Accept: application/sdp'</span>, <span class="hljs-keyword">None</span>, CRLF+user_agent_str+CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Added protocol version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 3'</span>, CRLF,
        <span class="hljs-string">'Transport: '</span>, <span class="hljs-keyword">None</span>, <span class="hljs-string">'/'</span>+ protocol_str+CRLF+user_agent_str+CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Protocol version with extra data and semicolon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 3'</span>, CRLF,
      <span class="hljs-string">'Transport: RTP/'</span>, <span class="hljs-keyword">None</span>, <span class="hljs-string">';'</span>+protocol_str+CRLF+user_agent_str+CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Even more protocol data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 3'</span>,CRLF,
      <span class="hljs-string">'Transport: RTP/AVP'</span>,<span class="hljs-keyword">None</span>,<span class="hljs-string">';'</span>+protocol_str+CRLF+user_agent_str+CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Request with session key but no value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 6'</span>, CRLF,
        <span class="hljs-string">'Session: '</span>, <span class="hljs-keyword">None</span>, CRLF+user_agent_str+CRLF+<span class="hljs-string">'\n'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Request with session key and session value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">None</span>, options.target, options.file, <span class="hljs-string">' RTSP/1.0'</span>, CRLF, <span class="hljs-string">'CSeq: 7'</span>, CRLF,
        <span class="hljs-string">'Session: '</span>+session_str+CRLF+<span class="hljs-string">'Range: npt='</span>, <span class="hljs-keyword">None</span>,
        CRLF+user_agent_str+CRLF+<span class="hljs-string">'\n'</span>)]

    logger.info(<span class="hljs-string">'Starting Junk Fuzz'</span>)
    junk_fuzz_output = junk_fuzz(options.min, options.max, options.step)
    send(junk_fuzz_output, options.target, options.port)

    s = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> format <span class="hljs-keyword">in</span> structured_formats:
        logger.info(<span class="hljs-string">'Starting Structured Fuzz Seq %s'</span> % str(s))</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Create list of requests that match the current format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        structured_fuzz_output = structured_fuzz(options.min, options.max,
                options.step, options.target, options.file, format)</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Mutate the requests according to the passed in MUTATOR_FUNC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> mutator_func <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>:
            structured_fuzz_output = mutator_func(structured_fuzz_output)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Send to the target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        send(structured_fuzz_output, options.target, options.port)
        s += <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Replaces the <code>None</code>s in the structured request formats with valid headers and
data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">flesh_out_data</span><span class="hljs-params">(data_tuple, method, size)</span>:</span>
    lst = list(data_tuple)</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The first <code>None</code> is always a method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lst[<span class="hljs-number">0</span>] = method</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>This list comprehension replaces the remaining <code>None</code>s with data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> tuple([gen_data(size) <span class="hljs-keyword">if</span> e <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span> <span class="hljs-keyword">else</span> e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> lst])</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>This function implements more intelligent fuzzing based on a subset of the
EBNF grammar for an RTSP request given in the RTSP RFC whitepaper. <strong>This
requires the installation of the
<a href="https://code.google.com/p/ouspg/wiki/Blab">Blab</a> tool </strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">do_grammar_fuzz</span><span class="hljs-params">(options, mutator_func, num)</span>:</span>
    requests = []</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>setup_sent</code> makes sure a play request is not sent before a setup request,
which is illegal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setup_sent = <span class="hljs-keyword">False</span>
    logger.info(<span class="hljs-string">'Starting grammar fuzz'</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(num):</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>First, get the basic request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        request = os.popen(<span class="hljs-string">"cat %s | blab"</span> % grammar_file).read()</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Add the URI to the target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        request = request.replace(<span class="hljs-string">'URI'</span>, <span class="hljs-string">'rtsp://%s/%s'</span> % (options.target,
                                options.file))</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Add a sequence number, which increases by one for every request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        body = <span class="hljs-string">'CSeq: %s%s'</span> % (str(i+<span class="hljs-number">1</span>), CRLF)
        setup_sent = setup_sent <span class="hljs-keyword">or</span> <span class="hljs-string">'SETUP'</span> <span class="hljs-keyword">in</span> request</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Continue if a PLAY is seen before a setup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> setup_sent <span class="hljs-keyword">and</span> <span class="hljs-string">'PLAY'</span> <span class="hljs-keyword">in</span> request:
            <span class="hljs-keyword">continue</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If there is a setup, we must add additional protocol information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-string">'SETUP'</span> <span class="hljs-keyword">in</span> request:
            body += <span class="hljs-string">'Transport: RTP/%s;%s'</span> % (protocol_str, CRLF)</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>If the request is to play, we need to add session info</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">elif</span> <span class="hljs-string">'PLAY'</span> <span class="hljs-keyword">in</span> request:
            body += <span class="hljs-string">'Range: npt=5-20%sSession=%s%s'</span> % (CRLF, session_str, CRLF)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Likewise with a pause</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">elif</span> <span class="hljs-string">'PAUSE'</span> <span class="hljs-keyword">in</span> request <span class="hljs-keyword">or</span> <span class="hljs-string">'RECORD'</span> <span class="hljs-keyword">in</span> request <span class="hljs-keyword">or</span> <span class="hljs-string">'TEARDOWN'</span> <span class="hljs-keyword">in</span> request:
            body += <span class="hljs-string">'Session=%s%s'</span> % (session_str, CRLF)</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Replace the body of the request with the body we just generated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        request = request.replace(<span class="hljs-string">"BODY"</span>, body)
        requests.append(request)</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Mutate the requests if a mutator function is given</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> mutator_func <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>:
        grammar_fuzz_output = mutator_func(requests)
    send(grammar_fuzz_output, options.target, options.port)</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h5 id="mutators">Mutators</h5>
<p>These functions change requests in ways that historically have lead to
exploits in VLC and other media players</p>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Replaces characters with spaces at random, which is the source of a past known
exploit in VLC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_mutate</span><span class="hljs-params">(requests)</span>:</span>
    mutated_requests = []
    <span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> requests:
        request = list(request)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>We only mutate <code>scale_factor * len(request)</code> times, which by default
is 10% of the request string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(int(mutate_scale_factor * len(request))):
            request[random.randint(<span class="hljs-number">0</span>,len(request)-<span class="hljs-number">1</span>)] = <span class="hljs-string">' '</span>
        request = <span class="hljs-string">""</span>.join(request)
        mutated_requests.append(request)
    <span class="hljs-keyword">return</span> mutated_requests</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Replaces the method with another method (for example, PAUSE to PLAY)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">method_mutate</span><span class="hljs-params">(requests)</span>:</span>
    mutated_requests = []
    <span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> requests:
        <span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> methods:
            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> request:
                new_method = methods[random.randint(<span class="hljs-number">0</span>,len(methods)-<span class="hljs-number">1</span>)]
                request = request.replace(method, new_method)
        mutated_requests.append(request)
    <span class="hljs-keyword">return</span> mutated_requests</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Simply adds a space to he beginning of requests, another known exploit in a
past version of VLC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">offset_mutate</span><span class="hljs-params">(requests)</span>:</span>
    mutated_requests = []
    <span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> requests:
        request = <span class="hljs-string">' '</span> + request
        mutated_requests.append(request)
    <span class="hljs-keyword">return</span> mutated_requests

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h4 id="set-up-script-flags-and-options">Set up script flags and options</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parser = OptionParser()
    parser.add_option(<span class="hljs-string">'-t'</span>, <span class="hljs-string">'--target'</span>, dest=<span class="hljs-string">'target'</span>,
            help=<span class="hljs-string">'IP of target machine'</span>,
            default=<span class="hljs-string">'127.0.0.1'</span>)

    parser.add_option(<span class="hljs-string">'-p'</span>, <span class="hljs-string">'--port'</span>, dest=<span class="hljs-string">'port'</span>,
            help=<span class="hljs-string">'Streaming port on target machine'</span>,
            type=int, default=<span class="hljs-number">554</span>)

    parser.add_option(<span class="hljs-string">'--min'</span>, dest=<span class="hljs-string">'min'</span>,
            help=<span class="hljs-string">'Minimum bytes of data'</span>,
            default=<span class="hljs-number">20</span>)

    parser.add_option(<span class="hljs-string">'--max'</span>, dest=<span class="hljs-string">'max'</span>,
            help=<span class="hljs-string">'Maximum bytes of data'</span>,
            default=<span class="hljs-number">100</span>)

    parser.add_option(<span class="hljs-string">'-s'</span>,<span class="hljs-string">'--step'</span>, dest=<span class="hljs-string">'step'</span>,
            help=<span class="hljs-string">'Step size between min and max'</span>,
            default=<span class="hljs-number">20</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>The only required command line parameter is the path to the streaming file
on the target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parser.add_option(<span class="hljs-string">'-f'</span>, <span class="hljs-string">'--file'</span>, dest=<span class="hljs-string">'file'</span>,
            help=<span class="hljs-string">'Path to stream file on host'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Get options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options, args = parser.parse_args()</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Set up logging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clear_log()
    logging.basicConfig(filename=log_file, level=logging.INFO)
    logger = logging.getLogger(__name__)</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Quit if there is no path on target machine</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> options.file <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
        logger.error(<span class="hljs-string">'ERROR: Remote stream file not specified, quitting'</span>)
        sys.exit(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Display current script settings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">print</span> <span class="hljs-string">'Script running with these options:'</span>
    <span class="hljs-keyword">print</span> options</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>We’ll set up an array such that each fuzzing method is run with no
mutation random mutation, method switching, and offset addition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mutators = [<span class="hljs-keyword">None</span>, random_mutate, method_mutate, offset_mutate]

    <span class="hljs-keyword">for</span> mutate_func <span class="hljs-keyword">in</span> mutators:
        logger.info(<span class="hljs-string">'Doing randomized fuzzing with mutator:%s'</span> % mutate_func)
        do_randomized_fuzz(options, mutate_func)
    <span class="hljs-keyword">for</span> mutate_func <span class="hljs-keyword">in</span> mutators:
        logger.info(<span class="hljs-string">'Doing grammar fuzzing with mutator:%s'</span> % mutate_func)
        do_grammar_fuzz(options, mutate_func, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h4 id="and-we-re-done-">And we’re done!</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">print</span> <span class="hljs-string">'Done! Check out the log file'</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
